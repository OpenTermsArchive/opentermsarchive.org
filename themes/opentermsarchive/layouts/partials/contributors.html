{{ $thumbnailWidth := or .thumbnailWidth 64 }}
{{ $thumbnailHeight := or .thumbnailHeight 64 }}

{{ $contributors := (resources.Get "allcontributorsrc.json" | unmarshal).contributors }}
{{ $allStaffNames := slice }}
{{ range site.Data.staff }}{{ $allStaffNames = union $allStaffNames . }}{{ end }}

{{ $remoteContributors := slice }}
{{ with resources.GetRemote "https://raw.githubusercontent.com/OpenTermsArchive/engine/main/.all-contributorsrc" }}
  {{ with .Err }}
    {{ errorf "%s" . }}
  {{ else }}
    {{ $remoteContributors = (.Content | unmarshal).contributors }}
  {{ end }}
{{ else }}
  {{ errorf "Unable to get the remote contributors" }}
{{ end }}

{{ $uniqueContributors := $contributors }}
{{ range $remoteContributor := $remoteContributors }}
  {{ $duplicate := false }}
  {{ range $contributors }}
    {{ if eq .name $remoteContributor.name }}
      {{ $duplicate = true }}
      {{ break }}
    {{ end }}
  {{ end }}
  {{ if not $duplicate }}
    {{ $uniqueContributors = $uniqueContributors | append $remoteContributor }}
  {{ end }}
{{ end }}

{{ $filteredContributors := slice }}
{{ range $contributor := $uniqueContributors }}
  {{ with $.type }}
    {{ if (in (index site.Data.staff .) $contributor.name)}}
      {{ $filteredContributors = $filteredContributors | append $contributor }}
    {{ end }}
  {{ else }}
    {{ if not (in $allStaffNames $contributor.name)}}
      {{ $filteredContributors = $filteredContributors | append $contributor }}
    {{ end }}
  {{ end }}
{{ end }}

<div class="contributors {{ with .class }}{{ . }}{{ end }} {{ with .showInfo }}contributors--show-infos{{ end }}">
  <div class="contributors__items">
    {{ range $contributor := $filteredContributors }}
      {{ $image := resources.Get (printf "/images/contributors/%s.jpg" ($contributor.name | urlize)) }}
      {{ with $contributor.avatar_url }}
        {{ $remoteImage := resources.GetRemote . }}
        {{ if or (eq $remoteImage.Data.ContentType "image/jpeg") (eq $remoteImage.Data.ContentType "image/png") }}
          {{ $image = $remoteImage }}
        {{ end }}
      {{ end }}
      <div class="contributor">
        <a class="contributor__link" href="{{ $contributor.profile }}" target="_blank" rel="nofollow noopener">
          {{ with $image }}<img class="contributor__image" src="{{ .RelPermalink }}" alt="{{ $contributor.name }}" width="{{ $thumbnailWidth }}" height="{{ $thumbnailHeight }}">{{ end }}
          {{ with $.showInfo }}<div class="contributor__info">{{ $contributor.name }}</div>{{ end }}
        </a>
      </div>
    {{ end }}
  </div>
</div>
